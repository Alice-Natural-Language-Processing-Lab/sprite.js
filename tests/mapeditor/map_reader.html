<!DOCTYPE html><html>
<head>
<title>Read map</title>
<meta name = "viewport" content = "width=device-width">
<style>
html, body{margin:1em;padding:0;font-size:0.8em;}
.sjs{
    border:2px #999 solid;
}
</style>
</head>
<body>
<p>(<span id="fps"></span>FPS,
load <span id="load"></span>%,
<span id="dropped"></span> dropped frames) 

JSON map reader for the JSON exporter from the <a href="http://www.mapeditor.org/">Map Editor 0.8</a> . Use keyboard or mouse to move.
</p>

<p>This map reader handles multiple layer of sprites and collision detection if you set the property collision:true to any sprite in the editor. 
To run it locally, you need to serve
the JSON files: python server.py.</p>

<p><label><input type="checkbox" id="scaleScene" />Scale the scene 2X</label></p>

<script src="../../sprite.js"></script>
<script src="../../lib/scrolling.js"></script>
<script src="../../lib/collision.js"></script>
<script src="../../lib/path.js"></script>
<script src="mapimport.js"></script>
<script>


var scene = sjs.Scene({w:600, h:400, autoPause:false});

var scaleSceneDom = document.getElementById('scaleScene');
var dropped = document.getElementById('dropped');
var fps = document.getElementById('fps');
var load = document.getElementById('load');

var scaleScene = false;
scaleSceneDom.onclick = function() {
    scaleScene = scaleSceneDom.checked;
    if(scaleScene) {
        scene.scale(2, 2);
    } else {
        scene.scale(1, 1);
    }
}

scene.main = main;
var local = true;
switch(window.location.protocol) {
   case 'http:':
   case 'https:':
     local = false;
     break;
   case 'file:':
     local = true;
     break;
}

if(local)
    sjs.map.loadMap('http://127.0.0.1:8000/map.json', scene);
else
    sjs.map.loadMap('map.json', scene);

function main() {

    var offsetx = 0;
    var offsety = 0;

    var input = scene.Input();

    var front = scene.Layer("front", {useCanvas:false});
    //scene.scale(2, 2);

    var surface= sjs.SrollingSurface(scene, scene.w, scene.h, function(layer, x, y) {
        layer.clear();
        sjs.map.paintOn(layer, x, y);
    });

    surface.update();
    var player = front.Sprite("character.png", {w:24, h:42, layer:front});
    var player_walk_down = sjs.Cycle([[0,0,10],[24, 0, 10], [48, 0, 10], [72, 0, 10]]);
    player_walk_down.addSprite(player);
    player.move(surface.w / 2 - player.w/2, surface.h / 2 - player.h);
    var target = null;

    function reduceTo(v, max) {
        if(v > max)
            return max;
        if(v < -max)
            return -max;
        return v;
    }

    function paint(ticker) {

        var mx = 0;
        var my = 0;
        var pixels = 4 * ticker.lastTicksElapsed;

        if(input.keyboard.up)
            my = -pixels;
        if(input.keyboard.down)
            my = pixels;
        if(input.keyboard.left)
            mx = -pixels;
        if(input.keyboard.right)
            mx = pixels;

        var x = (surface.x + surface.w / 2);
        var y = (surface.y + surface.h / 2);

        var collisionx = sjs.map.collides(x + mx, y);
        var collisiony = sjs.map.collides(x, y + my);

        if(input.mousereleased) {
            var mp = input.mouse.click;
            target = sjs.map.findPath(x, y, mp.x + surface.x, mp.y + surface.y);
        }

        if(input.arrows()) {
            target = null;
            player_walk_down.next(ticker.lastTicksElapsed);
            player_walk_down.update();
        }

        if(target) {
            var target_x = target.x - x;
            var target_y = target.y - y;
            var move_x = reduceTo(target_x, pixels);
            var move_y = reduceTo(target_y, pixels);

            surface.move(move_x, move_y);

            if(Math.abs(move_x) < pixels && Math.abs(move_y) < pixels)
                target = target.parent;

            player_walk_down.next(ticker.lastTicksElapsed);
            player_walk_down.update();
        }

        if(!collisionx || !collisiony) {
            if(!collisionx)
                surface.move(mx, 0);
            if(!collisiony)
                surface.move(0, my);
            surface.update();
        }


        player.update();

        if(scene.ticker.currentTick % 20 == 0) {
            fps.innerHTML = ticker.fps;
            load.innerHTML = ticker.load;
            dropped.innerHTML = ticker.droppedFrames;
        }

    }
    scene.Ticker(paint, {useAnimationRequest:true}).run();

}


</script>
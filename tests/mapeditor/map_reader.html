<!DOCTYPE html><html>
<head>
<title>Read map</title>
<meta name = "viewport" content = "width=device-width">
<style>
html, body{margin:0;padding:0}
.sjs{
    border:2px #999 solid;
}
</style>
</head>
<body>
<p><a href="http://www.mapeditor.org/">Map Editor</a> JSON map reader. Use keyboard to move.
(<span id="fps"></span>FPS, load <span id="load"></span>%)</p>
<script src="../../sprite.js"></script>
<script src="../../lib/scrolling.js"></script>
<script>

var map = null;
var tilelayers = [];
var scene = sjs.Scene({w:672, h:480, autoPause:false});

var map_source = document.createElement('script');
map_source.src = 'map.json';
document.head.appendChild(map_source);

function mapCallback(_map) {
    map = _map;
    
    for(index in map.layers) {
        var layer = map.layers[index];
        if(layer.type=="tilelayer") {
            tilelayers.push(layer)
        }
    }

    scene.loadImages(['tiles.png'], main);
}

function findTileset(gid) {
    // find the tileset for the gid
    var tileset = null;
    for(var i=0; i<map.tilesets.length; i++) {
        tileset = map.tilesets[i];
        if(gid < tileset.gid) {
            tileset = map.tilesets[i-1];
            break;
        }
    }
    return tileset;


}

function getSprite(gid) {
    // return the sprite according to the gid
    var tileset = findTileset(gid);
    gid = gid-1;
    var tw = tileset.tilewidth;
    var th = tileset.tileheight;

    var nb_x = tileset.imagewidth / tw | 0;
    var nb_y = tileset.imageheight / th | 0;

    var x = gid % nb_x;
    var y = gid / nb_x | 0;

    var sp = scene.Sprite(tileset.image, {w:tw, h:th, xoffset:x * tw, yoffset:y * th});
    return sp;
}

function main() {

    var offsetx = 0;
    var offsety = 0;
    var fps = document.getElementById('fps');
    var load = document.getElementById('load');
    var input = scene.Input();


    var surface= sjs.SrollingSurface(scene, scene.w, scene.h, function(layer, _x, _y) {
        if(map==null)
            return;

        _x = _x / 48.0 | 0;
        _y = _y / 48.0 | 0;
        layer.clear();

        for(var x = 0; x < (layer.w / 48); x++) {
            for(var y = 0; y < (layer.h / 48); y++) {
                for(var i in tilelayers) {
                    var tilelayer = tilelayers[i]; 
                    var gid = tilelayer.grid['c'+(_x + x)+';'+(_y + y)];
                    if(gid) {
                        var tile = getSprite(gid);
                        // we need to update the position as the Sprites are shared
                        tile.position(48 * x, 48 * y);
                        tile.canvasUpdate(layer);
                    }
                }
            }
        }
    });

    function paint(ticker) {
        if(input.keyboard.up)
            surface.move(0, -4 * ticker.lastTicksElapsed);
        if(input.keyboard.down)
            surface.move(0, 4 * ticker.lastTicksElapsed);
        if(input.keyboard.left)
            surface.move(-4 * ticker.lastTicksElapsed, 0);
        if(input.keyboard.right)
            surface.move(4 * ticker.lastTicksElapsed, 0);
        surface.update();
        if(scene.ticker.currentTick % 30 == 0) {
            fps.innerHTML = ticker.fps;
            load.innerHTML = ticker.load;
        }

    }
    scene.Ticker(paint, {useAnimationRequest:true}).run()

}

</script>
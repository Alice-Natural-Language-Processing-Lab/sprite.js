<!DOCTYPE html><html>
<head>
<title>Read map</title>
<meta name = "viewport" content = "width=device-width">
<style>
html, body{margin:0;padding:0}
.sjs{
    border:2px #999 solid;
}
</style>
</head>
<body>
<p><a href="http://www.mapeditor.org/">Map Editor</a> JSON map reader. Use keyboard to move.
(<span id="fps"></span>FPS, load <span id="load"></span>%)</p>
<script src="../../sprite.js"></script>
<script src="../../lib/scrolling.js"></script>
<script src="mapimport.js"></script>
<script>


var scene = sjs.Scene({w:672, h:480, autoPause:false});
sjs.map.loadMap('map.json', scene);


function main() {

    var offsetx = 0;
    var offsety = 0;
    var fps = document.getElementById('fps');
    var load = document.getElementById('load');
    var input = scene.Input();

    var surface= sjs.SrollingSurface(scene, scene.w, scene.h, function(layer, _x, _y) {
        _x = _x / 48.0 | 0;
        _y = _y / 48.0 | 0;
        layer.clear();

        for(var x = 0; x < (layer.w / 48); x++) {
            for(var y = 0; y < (layer.h / 48); y++) {
                for(var i in sjs.map.tilelayers) {
                    var tilelayer = sjs.map.tilelayers[i]; 
                    var gid = tilelayer.grid['c'+(_x + x)+';'+(_y + y)];
                    if(gid) {
                        var tile = sjs.map.getSprite(gid);
                        // we need to update the position as the Sprites are shared
                        tile.position(48 * x, 48 * y);
                        tile.canvasUpdate(layer);
                    }
                }
            }
        }
    });

    surface.update();

    console.log(sjs.map.staticCollision)

    function paint(ticker) {

        var mx = 0;
        var my = 0;

        if(input.keyboard.up)
            my = -4;
        if(input.keyboard.down)
            my = 4;
        if(input.keyboard.left)
            mx = -4;
        if(input.keyboard.right)
            mx = 4;

        var x = (surface.x + mx + surface.w / 2) / 48.0 | 0;
        var y = (surface.y + my + surface.h / 2) / 48.0 | 0;
        var collision = sjs.map.staticCollision['c'+(x)+';'+(y)];

        if(!collision) {
            surface.move(mx, my);
            surface.update();
        }

        if(scene.ticker.currentTick % 30 == 0) {
            fps.innerHTML = ticker.fps;
            load.innerHTML = ticker.load;
        }

    }
    scene.Ticker(paint, {useAnimationRequest:true}).run()

}

</script>